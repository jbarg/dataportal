#!/bin/sh
# $1 is the input directory
if [ $# -eq 0 ]
then
	CURDIR="."
else
	CURDIR=$1
	cd $1
fi

# Define the SRB project and root
SRB_PROJECT=`echo $PWD | rev | cut -d/ -f2 | rev`
SRB_ROOT=/opt/srb/$SRB_PROJECT

# This is the umask for the server operation.
umask 077

# srbData - points to the "data" directory where some log files (srbLog)
# and configuration files are located. The dafault is ../data.
# srbData=/projects/diglib/srb/SRB1_1_8Lock/data. 

# NSL_UNITREE_DIR defines the directory where the UniTree configuration 
# files can be found. This line should be commented out if this SRB does 
# not support UniTree access.
# NSL_UNITREE_DIR=/scratch0/pgress/unitree18

# srbKeytabName specifies the path where the SRB's DCE keytab file is located.
# This line should be commented out if this SRB does not support HPSS access.
# srbKeytabName=/users/sy/srb/private/.ktb_srb

# srbPrincipalName specifies DCE principal name. This is to be used together
# with srbKeytabName for DCE authentication of the SRB user.
# This line should be commented out if this SRB does not support HPSS access.
# srbPrincipalName=srb

# srbNoDCELogin specifies whether the SRB should carry out DCE login during
# startup. The default action (without defining srbNoDCELogin) is to
# do DCE login. This option is useful when the DCE login daemon is not
# functioning properly and you still want the SRB server to service requests
# other than HPSS.
# srbNoDCELogin=1

# hpssCOSId specifies the class id to be used for creating hpss files
# hpssCOSId=10

# HPSS_LS_NAME - This parameter specify the path for the LS (Location Server). 
# This is only needed if the default path is not built into the hpss library.
# You should check with your HPSS administrator regarding the parameter.
# This feature is valid only for version 4 of HPSS.
# HPSS_LS_NAME=/.../mob.llnl.gov/subsys/hpss/ls/group

# HPSS_SERVER_HOST - This parameter is valid only if this SRB server is
# HPSS enabled and uses NON-DCE for authentication. It specifies the
# HPSS server host/port_no if it is not the same as the default that built
# into the hpss library.
# HPSS_SERVER_HOST=hpss07i/1218

# HPSS_HOSTNAME is the env variable for the client host name used for TCP/IP
# communication with the HPSS server. Should use the internal switch if
# possible
#
# HPSS_HOSTNAME=hpss18i.sdsc.edu

# METADATA_FKREL specifies the location of the metadata.fkrel file.
METADATA_FKREL=../data/metadata.fkrel

# srbPort defines the port number the SRB frontend server is listening on.
# The default port number, if srbPort is not defined here, is set in 
# src/include/srb.h  (configure replaces there too)
#
# srbPort=@SRB_PORT@

# srbHost defines the host the local machine where the server is
# running. If this is not defined, then the default value is
# taken from ~/.srb/.MdasEnv file.
# srbHost=srb.sdsc.edu


# mcatZone defines the zoneID for the SRB server. If not defined,
# then the default value is taken from ~/.srb/.MdasEnv file.
# mcatZone=sdscdemo

# mdasDomainName defines the the domainName of the user that runs the
# SRB server. The user/domainName pair must already been registered with MCAT.
# Valid domainName are sdsc, ucb, caltech, etc.
# mdasDomainName=sdsc

# SHOW_MCAT_QUERY is an environment variable that specifies whether the
# MCAT designed queery needs to be logged into elog.
# If not needed comment out this variable.
# SHOW_MCAT_QUERY=1

# AUDIT_LEVEL is an environment variable that specifies whether to audit
# operations in SRB and if so at what level.
# Level 0  =  no auditing
# Level 1  =  anonymous auditing, userid zero unless user specifies with flag.
# If not needed, comment out this variable which implies no auditing.
# AUDIT_LEVEL=1

# GENERATE_GUID is an environment variable that specifies whether a 
# GlobalIdentifier will generated and stored as part of a srbObject 
# registration.
# if the value is undefined  or "NO_AUTO_GUID" then no GUID is generated.
# if the value is "STORE_AUTO_GUID" then SRB generates a GUID and stores it as
# part of system metadata.  If the value is "STORE_ZONE_DATA_ID" which is unique in a zone,
# then a zone:dataid string is stored. A user can insert or update GUID after registartion also.
# If not needed, comment out this variable. But if you plan on doing Zone Synchronization
# we recommend that you have some GUID preferably STORE_ZONE_DATA_ID.
# If you do use "STORE_AUTO_GUID" you should first replace src/lib/gen_uuid.c
# with the version at http://www.npaci.edu/DICE/SRB/tarfiles/gen_uuid.c; see
# either source file for more information.
# GENERATE_GUID=NO_AUTO_GUID
# GENERATE_GUID=STORE_AUTO_GUID
GENERATE_GUID=STORE_ZONE_DATA_ID

# ALLOW_NON_CHECKING_REGISTERY_OF_DATA is an environment variable that
# specifies whether to allow users to register data without checking
# if SRB is allowed to access it. Note that this can be a security hole.
# If not needed comment out this variable.
# ALLOW_NON_CHECKING_REGISTERY_OF_DATA=1


# PRE_SPAWN_CNT defines the number of srbServer to prespawn. If it is not
# defined, a value of 0 is assumed. The purpose of prespawning server is
# to improve interactivity. However, to prevent spawning a large number of
# idle servers, it is recommended that only the MCAT enabled servers should
# be prespawned.
# If PRE_SPAWN_CNT is 0, no prespawning of srbServer will be done and no 
# double connections (to the srbMaster and then to the srbServer) by the
# client since the socket established by the srbMaster can be inherited by
# the srbServer which means that ONLY ONE PORT can be used to connect to the
# SRB. However, if the server is sitting behind a firewall, multiple ports
# still need to be opened in the firewall for parallel I/O and bulk operations
# The SingleSvrPort flag should be used if the SRB server is required to
# use only one port to receive external connection.  
# 
PRE_SPAWN_CNT=1

# SingleSvrPort - This force the srbServer into the SingleSvrPort mode. 
# This parameter should be set if the server is required to use only one port 
# to receive external connection due to firewall issues. In this mode, 
# no prespawning of srbServer will be done regardless on the PRE_SPAWN_CNT
# setting. In addition, bulk load/unload and parallel put/get and copy will
# use only one port for the operations. It should be noted that this is a
# preliminary implementation and not all SRB operations been been tested
# with this configuration.
# 
# SingleSvrPort=1

# AUTH_SCHEME overrides the server to server auth scheme
AUTH_SCHEME=ENCRYPT1

# MaxThread defines the maximum number of threads to use for parallel
# transfer. The default is 4. Currently MaxThread cannot be set larger than
# 16
# MaxThread=16

# SizePerThread is used to calculate the number of threads to use based
# on the size of the file being transfered.
# numThreads = size/SizePerThread. SizePerThread is should be input
# in units of MBytes. The default value is 30 (30 MBytes).
# SizePerThread=2

# X509_USER_KEY and X509_USER_CERT specify where the SRB server's GSI
# key and certificate are located.
X509_USER_KEY=/users/sy/srb/.globus/userkey2.pem
X509_USER_CERT=/users/sy/srb/.globus/usercert.pem
LD_LIBRARY_PATH=$LD_LIBRARY_PATH:@GSIHOME@/lib

# GftpServerDn - Valid only if GRID_FTP driver is configured in this server.
# This defines the Distinguish Name of the user for the GridFTP server
# GftpServerDn="/C=US/O=NPACI/OU=SDSC/CN=Storage Resource Broker/USERID=srb"

# to point the '.srb/' directory to a different local file system (not AFS '~user/.srb./')
# replace '/local/tmp/.srb/.MdasEnv' with your own name
# replace '/local/tmp/.srb/.MdasAuth' with your own name
#
mdasAuthFile=$SRB_ROOT/.srb/.MdasAuth
mdasEnvFile=$SRB_ROOT/.srb/.MdasEnv

# STOR_VAULT_MODE - This allows the mode of files created in the vault to
# be changed to values different than the default value of 0600.
# STOR_VAULT_MODE=0640

# Fixes loss of master & server due to a bug in malloc. If the condition
# happens then only the one server will core dump, but master and other
# servers will remain stable
# MALLOC_CHECK_=2

# ServerTimeOut - This allows the srbServer process to timeout and exit if
# it has not received new commands from the connecting client/server for
# the number of seconds specified by ServerTimeOut. The ServerTimeOut vaule
# must not be too small especially on a MCAT enabled server because the
# connecting server may be busy transferring a very large file. Internally
# ServerTimeOut defaults to 7200 sec if it is set to less than this value.
# Setting ServerTimeOut also trigger a fixed 7200 sec timeout for the
# connection between the MCAT enabled server and the MCAT database.
# The connection to the MCAT database is re-established when a new request
# is received.
# ServerTimeOut=432000
ServerTimeOut=14400

# commPortNumStart - Specifies the first allowable port number for SRB 
# client/server. This overides the value specified with the --enable-commstart
# option of "configure". A zero value disable restriction on port number.
# commPortNumStart=20000

# commPortNumCount - Specifies the number of allowable ports for SRB 
# client/server. If commPortNumStart is specified and commPortNumCount is
# not specified, commPortNumCount defaults to 200. This overides the value 
# specified with the --enable-commnum option of "configure".
# commPortNumCount=200

export NSL_UNITREE_DIR srbData srbKeytabName srbPrincipalName METADATA_FKREL hpssCOSId srbPort srbHost mcatZone X509_USER_KEY X509_USER_CERT LD_LIBRARY_PATH PRE_SPAWN_CNT AUTH_SCHEME SHOW_MCAT_QUERY AUDIT_LEVEL ALLOW_NON_CHECKING_REGISTERY_OF_DATA GENERATE_GUID MaxThread SizePerThread mdasAuthFile mdasEnvFile STOR_VAULT_MODE MALLOC_CHECK_ ServerTimeOut GftpServerDn

export commPortNumStart commPortNumCount SingleSvrPort

mv $CURDIR/../data/srbLog $CURDIR/../data/log-archive/srbLog.`date +%Y%m%d-%H%M%S`
gzip $CURDIR/../data/log-archive/srbLog.`date +%Y%m%d-%H%M%S`
rm $CURDIR/../data/lockDir/.[a-z]* $CURDIR/../data/lockDir/*
$CURDIR/srbMaster-3.3.1-$SRB_PROJECT -d 1 -S

sleep 2
tail $CURDIR/../data/srbLog
# Need to use different ps options on Mac
hostOS=`uname -s`
if [ "$hostOS" = "Darwin" ]
then
    ps -ax | grep srbMaster
else
    ps -ef | grep srbMaster-3.3.1-$SRB_PROJECT
fi
