/*
Globus Toolkit Public License (GTPL)

Copyright (c) 1999 University of Chicago and The University of
Southern California. All Rights Reserved.

 1) The "Software", below, refers to the Globus Toolkit (in either
    source-code, or binary form and accompanying documentation) and a
    "work based on the Software" means a work based on either the
    Software, on part of the Software, or on any derivative work of
    the Software under copyright law: that is, a work containing all
    or a portion of the Software either verbatim or with
    modifications.  Each licensee is addressed as "you" or "Licensee."

 2) The University of Southern California and the University of
    Chicago as Operator of Argonne National Laboratory are copyright
    holders in the Software.  The copyright holders and their third
    party licensors hereby grant Licensee a royalty-free nonexclusive
    license, subject to the limitations stated herein and
    U.S. Government license rights.

 3) A copy or copies of the Software may be given to others, if you
    meet the following conditions:

    a) Copies in source code must include the copyright notice and
       this license.

    b) Copies in binary form must include the copyright notice and
       this license in the documentation and/or other materials
       provided with the copy.

 4) All advertising materials, journal articles and documentation
    mentioning features derived from or use of the Software must
    display the following acknowledgement:

    "This product includes software developed by and/or derived from
    the Globus project (http://www.globus.org/)."

    In the event that the product being advertised includes an intact
    Globus distribution (with copyright and license included) then
    this clause is waived.

 5) You are encouraged to package modifications to the Software
    separately, as patches to the Software.

 6) You may make modifications to the Software, however, if you
    modify a copy or copies of the Software or any portion of it,
    thus forming a work based on the Software, and give a copy or
    copies of such work to others, either in source code or binary
    form, you must meet the following conditions:

    a) The Software must carry prominent notices stating that you
       changed specified portions of the Software.

    b) The Software must display the following acknowledgement:

       "This product includes software developed by and/or derived
        from the Globus Project (http://www.globus.org/) to which the
        U.S. Government retains certain rights."

 7) You may incorporate the Software or a modified version of the
    Software into a commercial product, if you meet the following
    conditions:

    a) The commercial product or accompanying documentation must
       display the following acknowledgment:

       "This product includes software developed by and/or derived
        from the Globus Project (http://www.globus.org/) to which the
        U.S. Government retains a paid-up, nonexclusive, irrevocable
        worldwide license to reproduce, prepare derivative works, and
        perform publicly and display publicly."

    b) The user of the commercial product must be given the following
       notice:

       "[Commercial product] was prepared, in part, as an account of
        work sponsored by an agency of the United States Government.
        Neither the United States, nor the University of Chicago, nor
        University of Southern California, nor any contributors to
        the Globus Project or Globus Toolkit nor any of their employees,
        makes any warranty express or implied, or assumes any legal
        liability or responsibility for the accuracy, completeness, or
        usefulness of any information, apparatus, product, or process
        disclosed, or represents that its use would not infringe
        privately owned rights.

        IN NO EVENT WILL THE UNITED STATES, THE UNIVERSITY OF CHICAGO
        OR THE UNIVERSITY OF SOUTHERN CALIFORNIA OR ANY CONTRIBUTORS
        TO THE GLOBUS PROJECT OR GLOBUS TOOLKIT BE LIABLE FOR ANY
        DAMAGES, INCLUDING DIRECT, INCIDENTAL, SPECIAL, OR CONSEQUENTIAL
        DAMAGES RESULTING FROM EXERCISE OF THIS LICENSE AGREEMENT OR
        THE USE OF THE [COMMERCIAL PRODUCT]."

 8) LICENSEE AGREES THAT THE EXPORT OF GOODS AND/OR TECHNICAL DATA
    FROM THE UNITED STATES MAY REQUIRE SOME FORM OF EXPORT CONTROL
    LICENSE FROM THE U.S. GOVERNMENT AND THAT FAILURE TO OBTAIN SUCH
    EXPORT CONTROL LICENSE MAY RESULT IN CRIMINAL LIABILITY UNDER U.S.
    LAWS.

 9) Portions of the Software resulted from work developed under a
    U.S. Government contract and are subject to the following license:
    the Government is granted for itself and others acting on its
    behalf a paid-up, nonexclusive, irrevocable worldwide license in
    this computer software to reproduce, prepare derivative works, and
    perform publicly and display publicly.

10) The Software was prepared, in part, as an account of work
    sponsored by an agency of the United States Government.  Neither
    the United States, nor the University of Chicago, nor The
    University of Southern California, nor any contributors to the
    Globus Project or Globus Toolkit, nor any of their employees,
    makes any warranty express or implied, or assumes any legal
    liability or responsibility for the accuracy, completeness, or
    usefulness of any information, apparatus, product, or process
    disclosed, or represents that its use would not infringe privately
    owned rights.

11) IN NO EVENT WILL THE UNITED STATES, THE UNIVERSITY OF CHICAGO OR
    THE UNIVERSITY OF SOUTHERN CALIFORNIA OR ANY CONTRIBUTORS TO THE
    GLOBUS PROJECT OR GLOBUS TOOLKIT BE LIABLE FOR ANY DAMAGES,
    INCLUDING DIRECT, INCIDENTAL, SPECIAL, OR CONSEQUENTIAL DAMAGES
    RESULTING FROM EXERCISE OF THIS LICENSE AGREEMENT OR THE USE OF
    THE SOFTWARE.
*/

package org.nees.nsds.examples.client;

/**
 * <p>Title: NSDS Client</p>
 * <p>Description: Basic client to test Nsds Service</p>
 * <p>Copyright: Copyright (c) 2002</p>
 * <p>Company: ISI/USC</p>
 * @author Gaurang Mehta (gmehta@isi.edu)
 * @version 1.0
 */

import org.globus.axis.gsi.GSIConstants;
import org.globus.gsi.gssapi.auth.NoAuthorization;
import org.globus.gsi.gssapi.auth.HostAuthorization;
import org.globus.ogsa.utils.GSIUtils;
import org.nees.nsds.nsdsServer.service.NsdsServerServiceLocator;
import org.nees.nsds.nsdsServer.NsdsPortType;
import java.net.URL;
import gnu.getopt.Getopt;
import gnu.getopt.LongOpt;
import javax.xml.rpc.Stub;
import org.globus.ogsa.impl.security.authentication.Constants;

public class NsdsClient {
    private String channelname = new String();
    private String experiment = new String();
    private String sensor = new String();
    private String drivername = new String();
    private String uri = new String();
    private int command = 0;
    private String authorization=new String("host");

    public static void main (String[] args) {
	NsdsClient nclient = new NsdsClient();
	nclient.executeCommand(args);
    }

    //
    // This function makes out calls to the correct methods to invoke
    // depending on the command line parameters.
    //

    public void executeCommand(String[] args) {
	if(args.length<2) {
	    printLongVersion();
	    System.exit(0);
	}

	uri = args[0];
	LongOpt[] longOptions = generateValidOptions();

	Getopt g = new Getopt("NsdsClient", args, ":", longOptions, true);

	int option = 0;
	int noOfOptions = 0;

	while ((option = g.getopt()) != -1) {
	    //      System.out.println("Option tag " + option);
	    switch (option) {
	    case 'o':
		// create-channel option
		noOfOptions++;
		command = 1;
		break;
	    case 'r':
		// subscribe option
		noOfOptions++;
		command = 2;
		break;
	    case 'u':
		// unsubscribe option
		noOfOptions++;
		command = 3;
		break;
	    case 'k':
		// close-channel option
		noOfOptions++;
		command = 4;
		break;
	    case 'i':
		// daq-status option
		noOfOptions++;
		command = 5;
		break;
	    case 'e':
		// experiment option
		noOfOptions++;
		experiment = g.getOptarg();
		break;
	    case 's':
		// sensor option
		noOfOptions++;
		sensor = g.getOptarg();
		break;
	    case 'c':
		// channel name option
		noOfOptions++;
		channelname = g.getOptarg();
		break;
	    case 'd':
		// drivername option
		noOfOptions++;
		drivername = g.getOptarg();
		break;
	    case 'h':
		// help option
		printLongVersion();
		System.exit(0);
		break;
	    case 'a':
		// channel name option
		noOfOptions++;
		authorization = g.getOptarg();
		break;
	    }
	}

	switch (command) {
	case 1:
	    if ((noOfOptions < 1) || (noOfOptions > 2)) {
		printShortVersion();
	    } else {
		createChannel();
	    }
	    break;

	case 2:
	    // create-channel
	    if ((noOfOptions < 4) || (noOfOptions > 5)) {
		printShortVersion();
	    } else {
		subscribe(experiment, sensor, channelname);
	    }
	    break;

	case 3:
	    // create-channel
	    if ((noOfOptions < 4) || (noOfOptions > 5)) {
		printShortVersion();
	    } else {
		unsubscribe(experiment,sensor,channelname);
	    }
	    break;

	case 4:
	    // create-channel
	    if ((noOfOptions < 2) || (noOfOptions > 3)) {
		printShortVersion();
	    } else {
		closeChannel(channelname);
	    }
	    break;

	case 5:
	    // create-channel
	    if ((noOfOptions < 2) || (noOfOptions > 3)) {
		printShortVersion();
	    } else {
		daqStatus(drivername);
	    }
	    break;
	}
    }

    //
    // creates a new channel name for a client applet
    //

    private void createChannel() {
	try {
	    //	    NsdsServerServiceLocator locator = new NsdsServerServiceLocator();
	    //	    NsdsPortType nsds = locator.getnsdsServerPort(new URL(uri));

	    NsdsServerServiceLocator locator;
	    NsdsPortType nsds;

	    System.out.println("new NsdsServerServiceLocator");
	    locator = new NsdsServerServiceLocator();

	    System.out.println("getnsdsServerPort");
	    nsds = locator.getnsdsServerPort(new URL(uri));

	    // sets gsi mode
	    if (new URL(uri).getProtocol().equals("httpg")) {
		System.out.println("HTTPG");
		GSIUtils.setDefaultGSIProperties((Stub)nsds, new URL(uri));

		// use nsds certs rather then host certs
		((Stub)nsds)._setProperty(GSIConstants.GSI_AUTHORIZATION, new HostAuthorization(authorization));
		((Stub)nsds)._setProperty(Constants.GSI_SEC_CONV, Constants.ENCRYPTION);
	    } else {
		// error here to tell that only httpg mode is supported
		System.out.println("no HTTPG");
	    }

	    // this code will be in if loop when only secure mode to be supported.
	    System.out.println("nsds.createChannel");
	    String channel = nsds.createChannel();

	    System.out.println("Channelname: " + channel);
	} catch (Exception e) {
	    System.err.println("!!!Error trying to execute create channel!!!");
	    e.printStackTrace();
	}
    }

    //
    // subscribes a data stream
    //

    private void subscribe(String experiment, String sensor, String channelname) {
	try {
	    NsdsServerServiceLocator locator = new NsdsServerServiceLocator();
	    NsdsPortType nsds = locator.getnsdsServerPort(new URL(uri));

	    // sets gsi mode
	    if (new URL(uri).getProtocol().equals("httpg")) {
		GSIUtils.setDefaultGSIProperties((Stub)nsds, new URL(uri));
		// use nsds certs rather then host certs
		((Stub)nsds)._setProperty(GSIConstants.GSI_AUTHORIZATION, new HostAuthorization(authorization));
		((Stub)nsds)._setProperty(Constants.GSI_SEC_CONV, Constants.ENCRYPTION);
	    } else {
		// error here to tell that only httpg mode is supported
	    }

	    // this code will be in if loop when only secure mode to be supported.
	    String subscriptionid = nsds.subscribe(experiment,sensor,channelname);
	    System.out.println("Subscription id: " + subscriptionid);
	} catch (Exception e) {
	    System.err.println("!!!Error trying to execute subscribe!!!");
	    e.printStackTrace();
	}
    }

    //
    // unsubscribes a data stream
    //

    private void unsubscribe(String experiment, String sensor, String channelname) {
	try {
	    NsdsServerServiceLocator locator = new NsdsServerServiceLocator();
	    NsdsPortType nsds = locator.getnsdsServerPort(new URL(uri));
		
	    // sets gsi mode
	    if (new URL(uri).getProtocol().equals("httpg")) {
		GSIUtils.setDefaultGSIProperties((Stub)nsds, new URL(uri));
		// use nsds certs rather then host certs
		((Stub)nsds)._setProperty(GSIConstants.GSI_AUTHORIZATION, new HostAuthorization(authorization));
		((Stub)nsds)._setProperty(Constants.GSI_SEC_CONV, Constants.ENCRYPTION);
	    } else {
		// error here to tell that only httpg mode is supported
	    }

	    // this code will be in if loop when only secure mode to be supported.
	    boolean unsubscribeflag = nsds.unsubscribe(experiment,sensor,channelname);
	    if (unsubscribeflag) {
		System.out.println("Unsubscribed from : " + experiment + "," + sensor + " on " + channelname);
	    } else {
		System.err.println("!!!Error on server end while trying to execute unsubscribe!!!");
	    }
	} catch (Exception e) {
	    System.err.println("!!!Error trying to execute unsubscribe !!!");
	    e.printStackTrace();
	}
    }

    //
    // closes a client channel
    //

    private void closeChannel(String channelname) {
	try {
	    NsdsServerServiceLocator locator = new NsdsServerServiceLocator();
	    NsdsPortType nsds = locator.getnsdsServerPort(new URL(uri));

	    // sets gsi mode
	    if (new URL(uri).getProtocol().equals("httpg")) {
		GSIUtils.setDefaultGSIProperties((Stub)nsds, new URL(uri));
		// use nsds certs rather then host certs
		((Stub)nsds)._setProperty(GSIConstants.GSI_AUTHORIZATION, new HostAuthorization(authorization));
		((Stub)nsds)._setProperty(Constants.GSI_SEC_CONV, Constants.ENCRYPTION);
	    } else {
		// error here to tell that only httpg mode is supported
	    }

	    // this code will be in if loop when only secure mode to be supported.
	    boolean closeflag = nsds.closeChannel(channelname);
	    if (closeflag) {
		System.out.println("ChannelClosed: " + channelname);
	    } else {
		System.err.println("!!!Error on server end while trying to execute close channel!!!");
	    }
	} catch (Exception e) {
	    System.err.println("!!!Error trying to execute close channel!!!");
	    e.printStackTrace();
	}
    }

    //
    //  queries the daq status
    //

    private void daqStatus(String drivername) {
	try {
	    NsdsServerServiceLocator locator = new NsdsServerServiceLocator();
	    NsdsPortType nsds = locator.getnsdsServerPort(new URL(uri));
		
	    // sets gsi mode
	    if (new URL(uri).getProtocol().equals("httpg")) {
		GSIUtils.setDefaultGSIProperties((Stub)nsds, new URL(uri));
		// use nsds certs rather then host certs
		((Stub)nsds)._setProperty(GSIConstants.GSI_AUTHORIZATION, new HostAuthorization(authorization));
		((Stub)nsds)._setProperty(Constants.GSI_SEC_CONV, Constants.ENCRYPTION);
	    } else {
		// error here to tell that only httpg mode is supported
	    }

	    // this code will be in if loop when only secure mode to be supported.
	    String status = nsds.queryDaq(drivername);
	    System.out.println("Status of driver is: " + status);
	} catch (Exception e) {
	    System.err.println("!!!Error trying to execute daq status!!!");
	    e.printStackTrace();
	}
    }

    //
    // generates an array of valid <code>LongOpt</code> objects
    // which contain all the valid options to the Executable
    //

    public LongOpt[] generateValidOptions() {
	LongOpt[] longopts = new LongOpt[11];

	longopts[0] = new LongOpt("create-channel", LongOpt.NO_ARGUMENT, null, 'o');
	longopts[1] = new LongOpt("subscribe", LongOpt.NO_ARGUMENT, null, 'r');
	longopts[2] = new LongOpt("unsubscribe", LongOpt.NO_ARGUMENT, null, 'u');
	longopts[3] = new LongOpt("close-channel", LongOpt.NO_ARGUMENT, null, 'k');
	longopts[4] = new LongOpt("daq-status", LongOpt.NO_ARGUMENT, null, 'i');
	longopts[5] = new LongOpt("exp", LongOpt.REQUIRED_ARGUMENT, null, 'e');
	longopts[6] = new LongOpt("sensor", LongOpt.REQUIRED_ARGUMENT, null, 's');
	longopts[7] = new LongOpt("ch-id", LongOpt.REQUIRED_ARGUMENT, null, 'c');
	longopts[8] = new LongOpt("driver", LongOpt.REQUIRED_ARGUMENT, null, 'd');
	longopts[9] = new LongOpt("help", LongOpt.NO_ARGUMENT, null, 'h');
	longopts[10] = new LongOpt("auth", LongOpt.REQUIRED_ARGUMENT, null, 'a');

	return longopts;
    }

    // this method is used to print the long version of the command

    public void printLongVersion(){
	System.out.println("NsdsClient - A basic client used to talk to the Nsds Web Service.");
	System.out.println("Usage: java NsdsClient <nsds service handle> <operation> [arguments]..");
	System.out.println("");
	System.out.println("--create-channel");
	System.out.println("  Returns a unique channel id which your viewer client uses to connect");
	System.out.println("  to the Nsds Web Service.");
	System.out.println("");
	System.out.println("--subscribe --exp <experiment> --sensor <sensor> --ch-id <channelname>");
	System.out.println("  Subscribe a channel to a data stream.");
	System.out.println("     experiment is the experiment name");
	System.out.println("     sensor is the sensor name");
	System.out.println("     channelname is the channel id returned by create-channel");
	System.out.println("");
	System.out.println("--unsubscribe --exp <experiment> --sensor <sensor> --ch-id <channelname>");
	System.out.println("  Unsubscribe a channel from a streaming data.");
	System.out.println("     experiment is the experiment name");
	System.out.println("     sensor is the sensor name");
	System.out.println("     channelname is the channel id returned by create-channel");
	System.out.println("");
	System.out.println("--close-channel --ch-id <channelname>");
	System.out.println("  Close a data channel.");
	System.out.println("     channelname is the channel id returned by create-channel");
	System.out.println("");
	System.out.println("--daq-status --driver <drivername>");
	System.out.println("  Returns you the status of a daq.");
	System.out.println("    drivername is the name of the device driver");
	System.out.println("");
	System.out.println("--help");
	System.out.println("  Displays this message");
	System.out.println("");
	System.out.println("--auth <cert>");
	System.out.println("  This is an optional argument that can be used in conjunction with other");
	System.out.println("  commands.  If not specified, the client uses host cert authorization.");
	System.out.println("");
	System.out.println("Example usage");
	System.out.println("  java NsdsClient http://smarty.isi.edu:8080/ogsa/services/samples/nsds/NsdsWebService/test \\");
	System.out.println("    --subscribe --exp earthquake-sim-1 --sensor straingauge --ch-id nsds-channel-352345234234");
    }

    // this is used to print the short version of the command

    public void printShortVersion(){
	String text = "\n java NsdsClient - this is a basic client used to run the Nsds Web Service." +
	    "\n Usage: java NsdsClient <nsds service handle> <operation> [arguments].." +
	    "\n Try java NsdsClient --help for a detailed options list";

	System.err.println(text);
    }
}
